{% extends "metagame/base.html" %}

{% block extrahead %}
    <script type="text/javascript" charset="utf-8">
        var targetUser = '{{ target.user.username }}';
        var targetUserId = {{ target.user.id }};
        var moveId = 0;
        var message = '';
        
        var moves = {};
        {% for style in styles %}
            moves['{{ style.name }}'] = [];

            {% for move in style.move_set.all %}
                moves['{{ style.name }}'].push([{{ move.id }}, '{{ move.name }}']);
            {% endfor %}
        {% endfor %}
        
        function templateMove(move, name) {
            return move.replace('X', name);
        }
        
        function fillMoves(style) {
            $('#moves').empty();
            
            for (var counter in moves[style]) {
                var move = moves[style][counter];
                
                var extraclass = '';
                if (counter == 0) extraclass = 'selected';
                
                $('#moves').append('<li id="move_' + move[0] + '" class="move ' + extraclass + '">' + templateMove(move[1], targetUser) + '</li>');
            }
        }
        
        $(document).ready(function() {
            $('#challenge_form').ajaxForm({
                dataType: 'json',
                success: function(data) {
                    var awesomeness = data['awesomeness'];
                    
                    $('#challenge_button').replaceWith('<p>Je beweging heeft de coolness: ' + awesomeness + '</p>');
                }
            });
            
            $('.stylerow').mouseover(function() {
                $('.stylerow').removeClass('hover');
                
                var i = this.id.split('_')[2];
                $('#style_row_' + i).addClass('hover');
            });
            
            $('.stylerow').mouseout(function() {
                $('.stylerow').removeClass('hover');
            });
            
            $('.stylerow').click(function() {
                $('.stylerow').removeClass('active');
                $('.style_detail').removeClass('active');
                
                var i = this.id.split('_')[2];
                
                $('#style_row_' + i).addClass('active');
                $('#style_detail_' + i).addClass('active');
            });
            
            $('.choosestylebutton').click(function() {
                // Display the style pick field and show the chosen style
                var i = $(this).parent().attr('id').split('_')[2];
                
                var style = $('#style_row_' + i + ' TD.style').text();
                
                $('#stylechosen .stylename').html(style);
                
                $('#stylechoose').css('display', 'none');
                $('#stylechosen').css('display', 'block');
                $('#actionselect').css('display', 'block');
                
                // Also show the action choice field and fill the correct actions
                
                fillMoves(style);   
            });
            
            $('#changestylelink').click(function() {
                $('.stylerow').removeClass('active');
                $('.style_detail').removeClass('active');
                
                $('#stylechoose').css('display', 'block');
                $('#stylechosen').css('display', 'none');
                $('#actionselect').css('display', 'none');
            });
            
            $('#moves LI').live('click', function() {
                $('.move').removeClass('selected');
                
                var i = this.id.split('_')[1];
                
                $('#move_' + i).addClass('selected');
                
                // Store move id
                moveId = parseInt(i);
            });
            
            $('#makemovebutton').click(function() {
                $('#changestylelink').remove();
                
                // Display progress
                // TODO
                
                message = $('#messagetext').val();
                
                // Send move to server
                $.post('/challenge/', {
                    'target': targetUserId,
                    'move': moveId,
                    'message': message
                }, function(data) {
                    var awesomeness = data['awesomeness'];
                    
                    $('#actionselect').append('<img src="{{ MEDIA_URL }}image/stars_' + awesomeness + '.png">');
                }, 'json')
                
                // TODO also display move you made
                
                // Display result
                $('#actionselect').html('je move');
            });
        });
    </script>
    
    <style type="text/css" media="screen">
        #contentwrapper {
            background-color: #f5f5f5;
            background-image: url({{ MEDIA_URL }}image/grain_overlay.png);
            
            border-top: 5px solid #ddd;
        }
        
        #content {
            padding-top: 20px;
            padding-bottom: 40px;
            
            overflow: auto;
        }
    
        #player1 {
            
        }
        
        #player1 .you {
            float: right;
        }
        
        #vs {
            float: right;
            
            position: relative;
            right: -100px;
            top: 40px;
        }
        
        #player1 .headline {
            background-color: #b7d1d0;
        }
        
        #player2 {
            border: thin solid #ddd;
        }
        
        .player {
            width: 460px;
            
            float: left;
        }
        
        .player H5 {
            margin-top: 10px;
            color: #12151a;
        }
        
        .headline H2 {
            color: #f30;
        }
        
        .headline {
        }
        
        .name {
            padding-top: 20px;
            padding-bottom: 20px;
            padding-left: 40px;
        }
        
        #player1 .choice {
            border: 1px solid #ddd;
            border-top: 5px solid #ddd;
            
            background-color: white;
        }
        
        .styles TABLE {
            width: 95%;
            margin: 10px auto;
        }
        
        .styles TH {
            color: #bbb;
            text-align: left;
            
            font-size: 12px;
        }
        
        TR.toprow {
            border-bottom: thin solid #bbb;
        }
        
        TR.stylerow.hover, TR.stylerow.active {
            background-color: #f30;
        }
        
        TR.stylerow.hover TD, TR.stylerow.active TD {
            color: white;
        }
        
        TD, TH {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        TD {
            height: 30px;
            vertical-align: middle;
        }
        
        .odd {
            background-color: #f5f5f5;
        }
        
        TD.style {
            color: #f30;
        }
        
        TD.rank {
            width: 120px;
        }
        
        TD.level {
            width: 80px;
            vertical-align: middle;
        }
                
        TD.style_detail {
            display: none;
            
            background-color: #f6e9d7;
        }

        TD.style_detail.active {
            display: table-cell;
        }
        
        #stylechosen {
            display: none;
            
            padding: 10px 10px 0 10px;
        }
        
        #stylechosen A {
            text-decoration: none;
            color: #f30;
        }
        
        #stylechosen .stylename {
            color: #f30;
            text-transform: uppercase;
        } 
        
        #changestylelink {
            float: right;
        }
        
        #actionselect {
            padding: 10px;
            
            display: none;
        }
        
        #actionselect UL LI {
            list-style-type: none;
        }
        
        #actionselect LI {
            color: #f30;
            padding: 5px;
        }
        
        #actionselect LI.selected, #actionselect LI:hover {
            background-color: #f30;
            color: white;
            
            background-image: url({{ MEDIA_URL }}image/icon_check.png);
            background-position: 95% center;
            background-repeat: no-repeat;
        }
        
        DIV.message {
            padding: 10px;
        }
        
        .message H5 {
            color: #666;
        }
        
        .messagetext {
            width: 98%;
            height: 5em;
        }
        
        BUTTON.bang {
            background-image: url({{ MEDIA_URL }}image/action_buttons_medium.png);
            background-position: center center;
            border: none;
            background-color: transparent;
            
            width: 40px;
            height: 40px;
        }
        BUTTON.bang:hover {
            background-position: center top;
        }
        BUTTON.bang:active {
            background-position: center bottom;
        }
    </style>
{% endblock %}


{% block tagline %}{% endblock %}


{% block content %}
<div id="content" class="mainblock">
    
    <div id="player1" class="player">
        <img class="you" src="{{ MEDIA_URL }}image/tag_jij.png">
        
        <img id="vs" src="{{ MEDIA_URL }}image/vs_stars.png">
        
        <div class="headline">
            <div class="name">
                <h2>{{ user.username }}</h2>
                <p>18 in het algemeen klassement</p>
            </div>
        </div>
        
        <h5>Jouw stijl</h5>
        
        <div id="stylechoose" class="styles choice">
            <table>
                <tr class="toprow">
                    <th>Stijl</th>
                    <th>Jouw positie</th>
                    <th>Jouw niveau</th>
                </tr>
                
                {% for style in styles %}
                    <tr id="style_row_{{ style.id }}" class="stylerow {% cycle '' 'odd' %}">
                        <td class="style">{{ style.name }}</td>
                        <td class="rank">1</td>
                        <td class="level"><img src="{{ MEDIA_URL }}image/level_{{ forloop.counter }}.png"></td>
                    </tr>
                    <tr>
                        <td id="style_detail_{{ style.id }}" class="style_detail" colspan="3">
                            test<br>
                            <button class="door choosestylebutton"><p class="door">Kiezen</p></button>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
        
        <div id="stylechosen" class="chosenstyle choice">
            <a href="#" id="changestylelink">veranderen</a>
            
            <p class="stylename">teststyle</p>
        </div>
        
        <h5>Jouw actie</h5>
        
        <div id="actionselect" class="choice">
            <div>
                <ul id="moves">
                    <li class="move">Jij bestelt een Guillotine voor Lauda</li>
                </ul>
            </div>
            
            <div class="message">
                <h5>Jouw boodschap aan {{ target.user.username }}</h5>
                
                <textarea id="messagetext" class="messagetext" name="messagetext"></textarea>
                
                <p style="text-align: center;"><button type="submit" id="makemovebutton" class="bang"></button></p>
            </div>
        </div>
        
    </div>
    
    
    <div id="player2" class="player">
        <div class="headline">
            <div class="name">
                <h2>{{ target.user.username }}</h2>
                <p>18 in het algemeen klassement</p>
            </div>
        </div>
        
        <div class="style">
            
        </div>
    </div>
        
    
    <form method="POST" action="/challenge/" id="challenge_form">
    
    <p>Challenger: 
    
    {{ user.username }} - {{ user.get_profile }}
    
    <p>Kies <label for="style">je cultuur</label>:
        <select id="style" name="style">
            {% for style in styles %}
                <option value="{{ style.id }}">{{ style.name }}</option>
            {% endfor %}
        </select>
        en <label for="move">je beweging</label>:
        <select id="move" name="move">
            
        </select>
        
        <br>Laat nog <label for="message">een boodschap</label> achter voor je tegenstander: <input name="message" id="message">
    </p>
    
    <p>Target: 
    
    <input type="hidden" name="target" value="{{ target.id }}">
    {{ target.user.username }} ({{ target.rating }}) - {{ target.culture }}
    
    
    <p><button type="submit" id="challenge_button">Daag uit!</button></p>
    
    </form>
</div>
{% endblock %}

{% block activityfooter %}{% endblock %}
